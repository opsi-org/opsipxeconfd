set timeout=2

set theme=(memdisk)/theme/theme.txt
set gfxmode=1280x720
set gfxpayload=keep
terminal_output gfxterm
background_image (memdisk)/theme/background.png

set net_pxe_mac=$net_default_mac

regexp --set=1:m1 --set=2:m2 --set=3:m3 --set=4:m4 --set=5:m5 --set=6:m6 '^([0-9a-f]{1,2})\:([0-9a-f]{1,2})\:([0-9a-f]{1,2})\:([0-9a-f]{1,2})\:([0-9a-f]{1,2})\:([0-9a-f]{1,2})' "$net_pxe_mac"

set mac=${m1}-${m2}-${m3}-${m4}-${m5}-${m6}

smbios --type 1 --get-uuid 8 --set system_uuid
smbiosfile=${cmdpath}/../cfg/${system_uuid}
source $smbiosfile

pipefile=${cmdpath}/../cfg/01-${mac}
source $pipefile

if [ "$grub_platform" = "efi" ]; then
        search --no-floppy --file --set=bootable_efi /EFI/MICROSOFT/BOOT/BOOTMGFW.EFI
        if [ -n "${bootable_efi}" ]; then
                menuentry "Local Disk" --class unknown {
                        set root="${bootable_efi}"
                        chainloader /EFI/BOOT/BOOTX64.EFI
                        boot
                }
        else
                if [ -n "${bootable_efi}" ]; then
                        search --no-floppy --file --set=bootable_efi /EFI/BOOT/BOOTX64.EFI
                        menuentry "Local Disk" --class unknown {
                                set root="${bootable_efi}"
                                chainloader /EFI/MICROSOFT/BOOT/BOOTMGFW.EFI
                                boot
                        }
                else
                        if [ -n "${bootable_efi}" ]; then
                                search --no-floppy --file --set=bootable_efi /efi/Boot/bootx64.efi
                                menuentry "Local Disk" --class unknown {
                                        set root="${bootable_efi}"
                                        chainloader /efi/Boot/bootx64.efi
                                        boot
                                }
                        else
                                menuentry 'Local Disk' {
                                        exit
                                }
                        fi
                fi
        fi
else
        search --no-floppy --file --set=bootable_bios /Boot/BCD --hint hd0,msdos1
        if [ -n "${bootable_bios}" ]; then
                menuentry "Local Disk -- Windows" --class unknown {
                        set root="${bootable_bios}"
                        chainloader +1
                        boot
                }
        else
                search --no-floppy --file --set=bootable_bios /boot/grub/grub.cfg
                if [ -n "${bootable_bios}" ]; then
                        menuentry "Local Disk -- Linux" --class unknown {
                                configfile (${bootable_bios})/boot/grub/grub.cfg
                        }
                else
                        menuentry 'Local Disk' {
                                exit
                        }
                fi
        fi
fi

menuentry 'Start opsi bootimage (x64) - standard' {
        set gfxpayload=keep
        linux (pxe)/opsi/opsi-linux-bootimage/install-x64 initrd=miniroot-x64 video=vesa:ywrap,mtrr vga=791 --no-log console=tty1 console=ttyS0
        initrd (pxe)/opsi/opsi-linux-bootimage/miniroot-x64
}

menuentry 'Start opsi bootimage (x64) - acpi=off noapic' {
        set gfxpayload=keep
        linux (pxe)/opsi/opsi-linux-bootimage/install-x64 initrd=miniroot-x64 video=vesa:ywrap,mtrr vga=791 --no-log console=tty1 console=ttyS0 acpi=off noapic
        initrd (pxe)/opsi/opsi-linux-bootimage/miniroot-x64
}

menuentry 'Start opsi bootimage (x64) - acpi=off noapic mem=2G' {
        set gfxpayload=keep
        linux (pxe)/opsi/opsi-linux-bootimage/install-x64 initrd=miniroot-x64 video=vesa:ywrap,mtrr vga=791 --no-log console=tty1 console=ttyS0 acpi=off noapic mem=2G
        initrd (pxe)/opsi/opsi-linux-bootimage/miniroot-x64
}

menuentry 'Start opsi bootimage (x64) - modprobe.blacklist=intel_lpss_pci' {
        set gfxpayload=keep
        linux (pxe)/opsi/opsi-linux-bootimage/install-x64 initrd=miniroot-x64 video=vesa:ywrap,mtrr vga=791 --no-log console=tty1 console=ttyS0 modprobe.blacklist=intel_lpss_pci
        initrd (pxe)/opsi/opsi-linux-bootimage/miniroot-x64
}

menuentry 'Start opsi bootimage (x64) - edit with <e> and then boot with <F10>' {
        set gfxpayload=keep
        linux (pxe)/opsi/opsi-linux-bootimage/install-x64 initrd=miniroot-x64 video=vesa:ywrap,mtrr vga=791 --no-log console=tty1 console=ttyS0
        initrd (pxe)/opsi/opsi-linux-bootimage/miniroot-x64
}

menuentry 'Load custom boot menu' {
        configfile (pxe)/opsi/opsi-linux-bootimage/cfg/grub-custom.cfg
}

grub_platform
if [ "$grub_platform" = "efi" ]; then
menuentry 'UEFI Firmware Settings' {
        fwsetup
}
fi